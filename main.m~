%% ============================ Initial setup ============================
xxx
% Start brainstorm, if not open already
if ~brainstorm('status')
    brainstorm nogui
end
% The protocol name has to be a valid folder name (no spaces, no weird characters...)
ProtocolName = 'Perception';
% Delete existing protocol
% gui_brainstorm('DeleteProtocol', ProtocolName);
% Create new protocol
% gui_brainstorm('CreateProtocol', ProtocolName, 0, 0);

% Input files
reports_dir = '/home/anakin/Research/Results/';
SubjectNames = {'sub01', 'sub02', 'sub03', 'sub04', 'sub05', 'sub06', ...
    'sub07', 'sub09', 'sub10', 'sub11', 'sub12'};
RawFiles = {...
    '/home/anakin/Data/MEG/Perception/sub01/run_tsss.fif', ...
    '/home/anakin/Data/MEG/Perception/sub02/run_tsss.fif', ...
    '/home/anakin/Data/MEG/Perception/sub03/run_tsss.fif', ...
    '/home/anakin/Data/MEG/Perception/sub04/run_tsss.fif', ...
    '/home/anakin/Data/MEG/Perception/sub05/run_tsss.fif', ...
    '/home/anakin/Data/MEG/Perception/sub06/run_tsss.fif', ...
    '/home/anakin/Data/MEG/Perception/sub07/run_tsss.fif', ...
    '/home/anakin/Data/MEG/Perception/sub09/run_tsss.fif', ...
    '/home/anakin/Data/MEG/Perception/sub10/run_tsss.fif', ...
    '/home/anakin/Data/MEG/Perception/sub11/run_tsss.fif', ...
    '/home/anakin/Data/MEG/Perception/sub12/run_tsss.fif', ...
    };
NoiseFiles = {...
    '/home/anakin/Data/MEG/Perception/sub01/emptyroom_tsss.fif', ...
    '/home/anakin/Data/MEG/Perception/sub02/emptyroom_tsss.fif', ...
    '/home/anakin/Data/MEG/Perception/sub03/emptyroom_tsss.fif', ...
    '/home/anakin/Data/MEG/Perception/sub04/emptyroom_tsss.fif', ...
    '/home/anakin/Data/MEG/Perception/sub05/emptyroom_tsss.fif', ...
    '/home/anakin/Data/MEG/Perception/sub06/emptyroom_tsss.fif', ...
    '/home/anakin/Data/MEG/Perception/sub07/emptyroom_tsss.fif', ...
    '/home/anakin/Data/MEG/Perception/sub09/emptyroom_tsss.fif', ...
    '/home/anakin/Data/MEG/Perception/sub10/emptyroom_tsss.fif', ...
    '/home/anakin/Data/MEG/Perception/sub11/emptyroom_tsss.fif', ...
    '/home/anakin/Data/MEG/Perception/sub12/emptyroom_tsss.fif', ...
    };
RawEventFiles = {...
    '/home/anakin/Data/MEG/Perception/sub01/events_MarkerFile-bst.mat', ...
    '/home/anakin/Data/MEG/Perception/sub02/events_MarkerFile-bst.mat', ...
    '/home/anakin/Data/MEG/Perception/sub03/events_MarkerFile-bst.mat', ...
    '/home/anakin/Data/MEG/Perception/sub04/events_MarkerFile-bst.mat', ...
    '/home/anakin/Data/MEG/Perception/sub05/events_MarkerFile-bst.mat', ...
    '/home/anakin/Data/MEG/Perception/sub06/events_MarkerFile-bst.mat', ...
    '/home/anakin/Data/MEG/Perception/sub07/events_MarkerFile-bst.mat', ...
    '/home/anakin/Data/MEG/Perception/sub09/events_MarkerFile-bst.mat', ...
    '/home/anakin/Data/MEG/Perception/sub10/events_MarkerFile-bst.mat', ...
    '/home/anakin/Data/MEG/Perception/sub11/events_MarkerFile-bst.mat', ...
    '/home/anakin/Data/MEG/Perception/sub12/events_MarkerFile-bst.mat', ...
    };

%% ============ Load raw files, preprocess and import epochs =============
for iSubj=1:length(SubjectNames)
    % Start display report for each subject
    bst_report('Start');
    fprintf('\n===== IMPORT: SUBJECT #%d =====\n\n', iSubj);
    
    % If subject already exists: delete it
    [sSubject, iSubject] = bst_get('Subject', SubjectNames{iSubj});
    if ~isempty(sSubject)
        db_delete_subjects(iSubject);
    end
    
    sFiles = script1(SubjectNames, RawFiles, NoiseFiles, RawEventFiles, iSubj);
    
    % Save and display report
    ReportFile = bst_report('Save', []);
    if ~isempty(reports_dir) && ~isempty(ReportFile)
        bst_report('Export', ReportFile, bst_fullfile(reports_dir, ...
            ['report_' ProtocolName '_' SubjectNames{iSubj} '.html']));
    end
end

%% ======= Add leftover noise files and calculate noise covariance =======
% Start display report for all subjects
bst_report('Start');
for iSubj=1:length(SubjectNames)
    sFilesNoise = script1_aux(SubjectNames, NoiseFiles, iSubj);
end
% Save and display report
ReportFile = bst_report('Save', []);

%% ==================== Compute head model and sources ====================

%% ============================= Open report =============================
bst_report('Open', ReportFile);